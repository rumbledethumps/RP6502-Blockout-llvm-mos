#include <stdint.h>
#include <stdbool.h>
#include "blockout_types.h"
#include "blockout_math.h"


int16_t grid_sx[MAX_PIT_HEIGHT + 1][MAX_PIT_DEPTH + 1][MAX_PIT_WIDTH + 1];
int16_t grid_sy[MAX_PIT_HEIGHT + 1][MAX_PIT_DEPTH + 1];

/* ================= LUTS ================= */

const int16_t sine_values[256] = {
    0, 100, 200, 301, 401, 501, 601, 700,
    799, 897, 995, 1092, 1189, 1284, 1379, 1474,
    1567, 1659, 1751, 1841, 1930, 2018, 2105, 2191,
    2275, 2358, 2439, 2519, 2598, 2675, 2750, 2824,
    2896, 2966, 3034, 3101, 3166, 3229, 3289, 3348,
    3405, 3460, 3513, 3563, 3612, 3658, 3702, 3744,
    3784, 3821, 3856, 3889, 3919, 3947, 3973, 3996,
    4017, 4035, 4051, 4065, 4076, 4084, 4091, 4094,
    4096, 4094, 4091, 4084, 4076, 4065, 4051, 4035,
    4017, 3996, 3973, 3947, 3919, 3889, 3856, 3821,
    3784, 3744, 3702, 3658, 3612, 3563, 3513, 3460,
    3405, 3348, 3289, 3229, 3166, 3101, 3034, 2966,
    2896, 2824, 2750, 2675, 2598, 2519, 2439, 2358,
    2275, 2191, 2105, 2018, 1930, 1841, 1751, 1659,
    1567, 1474, 1379, 1284, 1189, 1092, 995, 897,
    799, 700, 601, 501, 401, 301, 200, 100,
    0, -100, -200, -301, -401, -501, -601, -700,
    -799, -897, -995, -1092, -1189, -1284, -1379, -1474,
    -1567, -1659, -1751, -1841, -1930, -2018, -2105, -2191,
    -2275, -2358, -2439, -2519, -2598, -2675, -2750, -2824,
    -2896, -2966, -3034, -3101, -3166, -3229, -3289, -3348,
    -3405, -3460, -3513, -3563, -3612, -3658, -3702, -3744,
    -3784, -3821, -3856, -3889, -3919, -3947, -3973, -3996,
    -4017, -4035, -4051, -4065, -4076, -4084, -4091, -4094,
    -4096, -4094, -4091, -4084, -4076, -4065, -4051, -4035,
    -4017, -3996, -3973, -3947, -3919, -3889, -3856, -3821,
    -3784, -3744, -3702, -3658, -3612, -3563, -3513, -3460,
    -3405, -3348, -3289, -3229, -3166, -3101, -3034, -2966,
    -2896, -2824, -2750, -2675, -2598, -2519, -2439, -2358,
    -2275, -2191, -2105, -2018, -1930, -1841, -1751, -1659,
    -1567, -1474, -1379, -1284, -1189, -1092, -995, -897,
    -799, -700, -601, -501, -401, -301, -200, -100,
};
const int16_t cosine_values[256] = {
    4096, 4094, 4091, 4084, 4076, 4065, 4051, 4035,
    4017, 3996, 3973, 3947, 3919, 3889, 3856, 3821,
    3784, 3744, 3702, 3658, 3612, 3563, 3513, 3460,
    3405, 3348, 3289, 3229, 3166, 3101, 3034, 2966,
    2896, 2824, 2750, 2675, 2598, 2519, 2439, 2358,
    2275, 2191, 2105, 2018, 1930, 1841, 1751, 1659,
    1567, 1474, 1379, 1284, 1189, 1092, 995, 897,
    799, 700, 601, 501, 401, 301, 200, 100,
    0, -100, -200, -301, -401, -501, -601, -700,
    -799, -897, -995, -1092, -1189, -1284, -1379, -1474,
    -1567, -1659, -1751, -1841, -1930, -2018, -2105, -2191,
    -2275, -2358, -2439, -2519, -2598, -2675, -2750, -2824,
    -2896, -2966, -3034, -3101, -3166, -3229, -3289, -3348,
    -3405, -3460, -3513, -3563, -3612, -3658, -3702, -3744,
    -3784, -3821, -3856, -3889, -3919, -3947, -3973, -3996,
    -4017, -4035, -4051, -4065, -4076, -4084, -4091, -4094,
    -4096, -4094, -4091, -4084, -4076, -4065, -4051, -4035,
    -4017, -3996, -3973, -3947, -3919, -3889, -3856, -3821,
    -3784, -3744, -3702, -3658, -3612, -3563, -3513, -3460,
    -3405, -3348, -3289, -3229, -3166, -3101, -3034, -2966,
    -2896, -2824, -2750, -2675, -2598, -2519, -2439, -2358,
    -2275, -2191, -2105, -2018, -1930, -1841, -1751, -1659,
    -1567, -1474, -1379, -1284, -1189, -1092, -995, -897,
    -799, -700, -601, -501, -401, -301, -200, -100,
    0, 100, 200, 301, 401, 501, 601, 700,
    799, 897, 995, 1092, 1189, 1284, 1379, 1474,
    1567, 1659, 1751, 1841, 1930, 2018, 2105, 2191,
    2275, 2358, 2439, 2519, 2598, 2675, 2750, 2824,
    2896, 2966, 3034, 3101, 3166, 3229, 3289, 3348,
    3405, 3460, 3513, 3563, 3612, 3658, 3702, 3744,
    3784, 3821, 3856, 3889, 3919, 3947, 3973, 3996,
    4017, 4035, 4051, 4065, 4076, 4084, 4091, 4094,
};

uint16_t persp_lut[256];

const uint16_t zoom_lut[NUM_ZOOM_LEVELS] = {
    8192, 4096, 2048, 1024, 896, 768, 640, 512
};



/* ================= GEOMETRY ================= */

#define UNIT_SCALE 1024 

const int16_t ref_vertices[8][3] = {
    {-UNIT_SCALE,-UNIT_SCALE,-UNIT_SCALE},
    { UNIT_SCALE,-UNIT_SCALE,-UNIT_SCALE},
    { UNIT_SCALE, UNIT_SCALE,-UNIT_SCALE},
    {-UNIT_SCALE, UNIT_SCALE,-UNIT_SCALE},
    {-UNIT_SCALE,-UNIT_SCALE, UNIT_SCALE},
    { UNIT_SCALE,-UNIT_SCALE, UNIT_SCALE},
    { UNIT_SCALE, UNIT_SCALE, UNIT_SCALE},
    {-UNIT_SCALE, UNIT_SCALE, UNIT_SCALE}
};

const uint8_t edges[24] = {
    0,1, 1,2, 2,3, 3,0,
    4,5, 5,6, 6,7, 7,4,
    0,4, 1,5, 2,6, 3,7
};

/* ================= ANGLES ================= */

uint8_t angleX=0, angleY=0, angleZ=0;
uint8_t targetX=0, targetY=0, targetZ=0;

/* ================= ROTATION CACHE ================= */

uint8_t last_ax=255, last_ay=255, last_az=255;
uint8_t last_shape=255;
uint8_t last_zoom=255;

int16_t g_sinX, g_cosX;
int16_t g_sinY, g_cosY;
int16_t g_sinZ, g_cosZ;

int16_t rot_ref_v[8][3];
int16_t scaled_ref_v[8][3];
int16_t block_centers[MAX_BLOCKS][3];
int16_t scaled_block_centers[MAX_BLOCKS][3];

int16_t px[8], py[8];


/* ================= PRECOMPUTE ================= */

void precompute_tables(void) {
    persp_lut[0]=65535;
    for(uint16_t i=1;i<256;i++) persp_lut[i]=65536U/i;
}

// Precompute ALL screen coordinates once. 
void precompute_grid_coordinates(void) {
    int16_t grid_x = GRID_SIZE;
    int16_t grid_y = GRID_SIZE;
    int16_t centerX = SCREEN_CENTER_X + VIEWPORT_X;
    int16_t centerY = SCREEN_CENTER_Y + VIEWPORT_Y;

    for (uint8_t z = 0; z <= PIT_HEIGHT; z++) {
        uint16_t zi = PIT_Z_START + (z * PIT_Z_STEP);
        
        for (uint8_t y = 0; y <= PIT_DEPTH; y++) {
            int16_t wy = (y * grid_y) - (VIEWPORT_HEIGHT / 2);
            int16_t py = apply_perspective(wy, (uint8_t)zi) + centerY;
            grid_sy[z][y] = py;

            for (uint8_t x = 0; x <= PIT_WIDTH; x++) {
                int16_t wx = (x * grid_x) - (VIEWPORT_WIDTH / 2);
                int16_t px = apply_perspective(wx, (uint8_t)zi) + centerX;

                grid_sx[z][y][x] = px;
            }
        }
    }
}

/* ================= ROTATION ================= */

void rotate_ref_vertex(const int16_t *v, int16_t *o) {
    int32_t x = v[0], y = v[1], z = v[2];

    int32_t ry = (x * g_cosY + z * g_sinY) >> 12;
    int32_t rz = (z * g_cosY - x * g_sinY) >> 12;

    int32_t rx = ry;
    int32_t ry2 = (y * g_cosX - rz * g_sinX) >> 12;
    int32_t rz2 = (y * g_sinX + rz * g_cosX) >> 12;

    o[0] = (int16_t)((rx * g_cosZ - ry2 * g_sinZ) >> 12);
    o[1] = (int16_t)((rx * g_sinZ + ry2 * g_cosZ) >> 12);
    o[2] = (int16_t)rz2;
}

void rotate_block_center(const int8_t *o, const int8_t *center, int16_t *v) {
    int16_t tmp[3] = {
        (int16_t)(o[0] * 2 - center[0]) * CUBE_SIZE,
        (int16_t)(o[1] * 2 - center[1]) * CUBE_SIZE,
        (int16_t)(o[2] * 2 - center[2]) * CUBE_SIZE
    };
    rotate_ref_vertex(tmp, v);
}
